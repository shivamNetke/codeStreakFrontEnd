<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeStreak</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h2>Welcome to CodeStreak</h2>
    <textarea id="code-input" rows="10" placeholder="Paste your code here..."></textarea>
    <button onclick="submitCode()">Submit Code</button>
    <p id="message"></p>

    <h3>Your Streak</h3>
    <p id="streak">Loading...</p>

    <h3>Submission Calendar</h3>
    <div id="calendar" style="display: flex; flex-wrap: wrap;"></div>

    <h3>Your Submission History</h3>
    <ul id="history"></ul>
  </div>

  <script>
    const API_URL = 'https://codestreak.onrender.com';

    function getTodayDateStr() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    async function submitCode() {
      const code = document.getElementById('code-input').value.trim();
      const message = document.getElementById('message');
      const today = getTodayDateStr();
      const username = localStorage.getItem('username');

      if (!username || !code) {
        message.textContent = "Login required and code cannot be empty.";
        return;
      }

      const res = await fetch(`${API_URL}/submit-code`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, code, date: today })
      });

      const data = await res.json();
      if (data.success) {
        message.textContent = "Code submitted successfully! ðŸ”¥";
        document.getElementById('code-input').value = "";
        fetchCodesAndRender();
      } else {
        message.textContent = data.message;
      }
    }

    async function fetchCodesAndRender() {
      const username = localStorage.getItem('username');
      if (!username) return;

      const res = await fetch(`${API_URL}/get-data/${username}`);
      const data = await res.json();

      if (data.success) {
        const codes = data.data;
        updateCalendar(codes);
        updateHistory(codes);
        updateStreak(codes);
      }
    }

    function updateCalendar(codes) {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = "";
      const sortedDates = Object.keys(codes).sort();

      sortedDates.forEach(date => {
        const div = document.createElement('div');
        div.textContent = date;
        div.style.background = '#90ee90';
        div.style.margin = '2px';
        div.style.padding = '4px';
        div.style.borderRadius = '6px';
        calendar.appendChild(div);
      });
    }

    function updateHistory(codes) {
      const history = document.getElementById('history');
      history.innerHTML = "";
      const sorted = Object.entries(codes).sort((a, b) => new Date(b[0]) - new Date(a[0]));

      sorted.forEach(([date, code]) => {
        const li = document.createElement('li');
        li.textContent = `${date}: ${code.slice(0, 30)}...`;
        history.appendChild(li);
      });
    }

    function updateStreak(codes) {
      const dates = Object.keys(codes).sort().reverse();
      let streak = 0;
      let currentDate = new Date();

      for (const date of dates) {
        const codeDate = new Date(date);
        if (codeDate.toDateString() === currentDate.toDateString()) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }

      document.getElementById('streak').textContent = `${streak} day streak!`;
    }

    fetchCodesAndRender();
  </script>
</body>
</html>
